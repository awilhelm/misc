#!/bin/sh

pid=$(pgrep -u "$USER" -x wallpaper-roule)
pid=$(echo "$pid" | grep -v ^$$$ | tr [:space:] ,)

export PATH="$(dirname "$0")/../lib/wallpaper-roulette:$PATH"

export TMPDIR="${XDG_CACHE_HOME:="$HOME/.cache"}/wallpaper-roulette"
mkdir -p "$TMPDIR"

if ! [ "$pid" ]
then echo "$1" >"$TMPDIR/interval"
shift
fi

mv "$TMPDIR/cmd" "$TMPDIR/cmd~"
for a
do echo "$a"
done >"$TMPDIR/cmd"

if ! [ "$pid" ]
then while true
do
	while test $(du -sB1 "$TMPDIR" | cut -f1) -gt 500000000
	do find "$TMPDIR" -type f | xargs -rd \\n ls -rt | head -1 | xargs -rd \\n rm
	done

	while ! LC_ALL=C gnome-screensaver-command -q | grep -q 'inactive'
	do sleep 1
	done

	{
		file=$(xargs -rd \\n env <"$TMPDIR/cmd") || continue
		touch -c "$file"
		gsettings set org.gnome.desktop.background picture-uri "file://$file"
	} 2>&1 | awk '{print "icon: preferences-desktop-wallpaper"; print "message: " $0}'
	xargs sleep <"$TMPDIR/interval"
done | zenity --notification --listen
else pkill -P "$pid" xargs
fi
